library(Seurat)  
library(data.table)

setwd('/Users/smrsp/lung cancer/DATA')
scRNA=readRDS('./scRNA_anno.RDS')
DotPlot(scRNA,features = 'RPS2')
library(viridis)

library(Nebulosa)
FeaturePlot(scRNA,features = 'RPS2',label = T,order = T,pt.size = 0.5,cols = magma(10))

plot_density(scRNA,'RPS2')

library(Seurat)
table(scRNA$celltype)
scRNA_mali=subset(scRNA,celltype=='Malignant cell')

scRNA_mali$gene_group=ifelse(as.numeric(scRNA_mali@assays$RNA@counts['RPS2',])>0,'RPS2+Mali','RPS2-Mali')

scRNA_other=subset(scRNA,celltype != 'Malignant cell')
scRNA_other$gene_group=scRNA_other$celltype
scRNA_chat=merge(scRNA_mali,scRNA_other)
set.seed(123456)
a=sample(1:ncol(scRNA_chat),3000)
scRNA_chat=scRNA_chat[,a]

meta =scRNA_chat@meta.data # a dataframe with rownames containing cell mata data

data_input <- as.matrix(scRNA_chat@assays$RNA@data)
identical(colnames(data_input),rownames(meta))

library(CellChat)
cellchat <- createCellChat(object = data_input, meta = meta, group.by = "gene_group")

CellChatDB <- CellChatDB.human 
groupSize <- as.numeric(table(cellchat@idents))
CellChatDB.use <- subsetDB(CellChatDB, search = c("Secreted Signaling",'Cell-Cell Contact') )
cellchat@DB <- CellChatDB.use 

dplyr::glimpse(CellChatDB$interaction)
cellchat <- subsetData(cellchat)
cellchat <- identifyOverExpressedGenes(cellchat)
cellchat <- identifyOverExpressedInteractions(cellchat)
cellchat <- projectData(cellchat, PPI.human)
unique(cellchat@idents)
cellchat <- computeCommunProb(cellchat)

# Filter out the cell-cell communication if there are only few number of cells in certain cell groups
cellchat <- filterCommunication(cellchat,min.cells = 0)
cellchat <- computeCommunProbPathway(cellchat,thresh = 1)
df.net<- subsetCommunication(cellchat,thresh = 1)


rt=df.net
rt$cell_cell=paste0(rt$source,"|",rt$target)
rt_means=rt[,c('cell_cell','prob','interaction_name')]
colnames(rt_means)[3]='interacting_pair'

library(tidyverse)
means_cellchat=pivot_wider(rt_means,names_from = 'cell_cell',values_from = 'prob',values_fill = 0.000)
means_cellchat$id_cp_interaction=paste0('CPI-',seq(1:nrow(means_cellchat)))

means_cellchat=as.data.frame(means_cellchat)


rt_pvalues=rt[,c('cell_cell','pval','interaction_name')]
colnames(rt_pvalues)[3]='interacting_pair'

pvalues_cellchat=pivot_wider(rt_pvalues,names_from = 'cell_cell',values_from = 'pval',values_fill = 1.000)
pvalues_cellchat$id_cp_interaction=paste0('CPI-',seq(1:nrow(pvalues_cellchat)))

pvalues_cellchat=as.data.frame(pvalues_cellchat)

sce=as.SingleCellExperiment(scRNA_chat)
table(scRNA_chat$gene_group)
install.packages("devtools")
library(devtools)
install_github("zktuong/ktplots")
library(ktplots)

pvalues_cellchat1=pvalues_cellchat
pvalues_cellchat1$id_cp_interaction=NULL
plot_cpdb_heatmap(pvalues_cellchat1)

install.packages("viridis")
library(viridis)

plot_cpdb(scdata =sce, cell_type1 = 'TAM', cell_type2 ='Mali' ,
          col_option = magma(10),
          max_highlight_size = 3,
          keep_significant_only = T,max_size =3,
          standard_scale = T,
          celltype_key="gene_group",# column name where the cell ids are located in the metadata
          splitby_key ="Experiment", # column name where the grouping column is. Optional.
          means = means_cellchat, pvals = pvalues_cellchat,
) +
  small_axis(fontsize = 7) + small_grid() + small_guide() 

scRNAsub=subset(scRNA_chat,celltype =='Malignant cell')

scRNAsub <- FindVariableFeatures(scRNAsub, selection.method = "vst", nfeatures = 3000) 
scale.genes <-  VariableFeatures(scRNAsub)
scRNAsub <- ScaleData(scRNAsub, features = scale.genes)
scRNAsub <- RunPCA(scRNAsub, features = VariableFeatures(scRNAsub)) 
plot1 <- DimPlot(scRNAsub, reduction = "pca", group.by="orig.ident") 
plot2 <- ElbowPlot(scRNAsub, ndims=20, reduction="pca") 
plotc <- plot1+plot2
plotc

library(harmony)
set.seed(1000)
scRNAsub <- RunHarmony(scRNAsub, group.by.vars = "orig.ident")
DimPlot(scRNAsub, reduction = "harmony", group.by = "orig.ident")

ElbowPlot(scRNAsub,reduction = 'harmony')


scRNAsub <- FindNeighbors(scRNAsub, reduction = 'harmony',dims = 1:10)
scRNAsub <- FindClusters(scRNAsub)
scRNAsub <- RunUMAP(scRNAsub, reduction = 'harmony',dims = 1:10)

DimPlot(scRNAsub, label=TRUE) 

BiocManager::install('Nebulosa')
library(Nebulosa)
FeaturePlot(scRNAsub,features = 'RPS2',label = T,order = T,pt.size = 0.5,cols = magma(10))

plot_density(scRNAsub,'RPS2')

VEC = scRNAsub@reductions$umap@cell.embeddings
rownames(VEC) = colnames(scRNAsub)
PCA =scRNAsub@reductions$harmony@cell.embeddings
source("https://raw.githubusercontent.com/jumphone/Vector/master/Vector.R")

PCA=vector.rankPCA(PCA)
OUT=vector.buildGrid(VEC, N=30,SHOW=TRUE)
OUT=vector.buildNet(OUT, CUT=1, SHOW=TRUE)
OUT=vector.getValue(OUT, PCA, SHOW=TRUE)
OUT=vector.gridValue(OUT,SHOW=TRUE)
OUT=vector.autoCenter(OUT,UP=0.9,SHOW=TRUE)
OUT=vector.drawArrow(OUT,P=0.9,SHOW=TRUE, COL=OUT$COL, SHOW.SUMMIT=TRUE)


